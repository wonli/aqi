<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>API 文档调试工具</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script>
        // 文档列表数据（通过模板注入）
        window.__DOCS_CONFIG__ = {{.DocsConfig}} || [];
    </script>
    <style>
        /* 自定义滚动条样式 */
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 3px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        /* 启动加载体验：应用未就绪前只展示 Loading */
        [v-cloak] { display: none; }
        body:not(.app-ready) #app { display: none; }
        body.app-ready #boot-loading { display: none; }
    </style>
</head>
<body class="bg-gray-50">
    <!-- 启动 Loading：在 Vue 完成初始化前仅显示此区域 -->
    <div id="boot-loading" class="fixed inset-0 flex items-center justify-center bg-gray-50">
        <div class="text-center text-gray-500">
            <div class="mx-auto mb-4 h-10 w-10 rounded-full border-4 border-gray-200 border-t-blue-600 animate-spin"></div>
            <p class="text-base">Loading...</p>
        </div>
    </div>

    <div id="app" v-cloak>
        <!-- 顶部文档切换器 -->
        <div v-if="availableDocs.length > 1" class="bg-white border-b border-gray-200 px-4 py-2 flex items-center gap-2">
            <!-- 菜单展开按钮（小屏幕显示，菜单关闭时） -->
            <button v-if="!menuOpen" 
                    @click="menuOpen = true"
                    class="md:hidden px-2 py-1 bg-white border border-gray-300 rounded-md shadow-md hover:bg-gray-50 flex items-center justify-center">
                <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/>
                </svg>
            </button>
            <!-- 菜单关闭按钮（小屏幕显示，菜单打开时） -->
            <button v-if="menuOpen" 
                    @click="menuOpen = false"
                    class="md:hidden px-2 py-1 bg-white border border-gray-300 rounded-md shadow-md hover:bg-gray-50 flex items-center justify-center">
                <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
            </button>
            <!-- 文档切换按钮组 -->
            <div class="flex items-center gap-1 flex-wrap">
                <button v-for="doc in availableDocs" 
                        :key="doc.name"
                        @click="switchToDocument(doc.name)"
                        :class="[
                            'px-3 py-1 text-sm border rounded-md transition-colors',
                            currentDocName === doc.name
                                ? 'bg-blue-600 text-white border-blue-600 hover:bg-blue-700'
                                : 'bg-white text-gray-700 border-gray-300 hover:bg-gray-50'
                        ]">
                    {{ doc.label }}
                </button>
            </div>
        </div>

        <div class="flex h-screen relative" style="height: calc(100vh - 40px);">
            <!-- 遮罩层（小屏幕菜单打开时显示） -->
            <div v-if="menuOpen" 
                 @click.stop="menuOpen = false"
                 class="md:hidden fixed inset-0 bg-black bg-opacity-50 z-20"></div>
            
            <!-- 左侧树形菜单 -->
            <div :class="[
                'bg-white border-r border-gray-200 overflow-y-auto custom-scrollbar transition-transform duration-300 ease-in-out',
                'fixed md:static inset-y-0 left-0 z-30',
                menuOpen ? 'translate-x-0' : '-translate-x-full md:translate-x-0',
                'w-80'
            ]">
                <!-- 关闭按钮（小屏幕显示） -->
                <div class="md:hidden flex justify-end p-2 border-b border-gray-200">
                    <button @click.stop="menuOpen = false" class="p-2 hover:bg-gray-100 rounded-md z-50 relative">
                        <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                    </button>
                </div>
                <div class="p-4">
                    <h2 class="text-xl font-semibold text-gray-800 mb-5">API 列表</h2>
                    <div v-if="docData && docData.files && docData.files.length > 0">
                        <div v-for="file in docData.files" :key="file.fileName">
                            <div v-for="group in file.middlewareGroups" 
                                 :key="group.name" 
                                 v-show="hasMatchingActionsInGroup(group)"
                                 class="mb-3">
                                <!-- Middleware Group -->
                                <div class="mb-2">
                                    <button @click="toggleGroup(group.name)" 
                                            class="w-full text-left px-4 py-2.5 flex items-center justify-between text-base font-medium text-gray-800 hover:text-gray-900 transition-colors">
                                        <span>{{ group.name }}</span>
                                        <svg class="w-4 h-4 text-gray-500 transition-transform duration-200" 
                                             :class="expandedGroups[group.name] ? 'rotate-90' : ''"
                                             fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                                        </svg>
                                    </button>
                                    
                                    <!-- Categories -->
                                    <div v-show="expandedGroups[group.name]" class="ml-2 mt-1">
                                        <div v-for="category in group.categories" 
                                             :key="category.name" 
                                             v-show="hasMatchingActionsInCategory(category)"
                                             class="mb-1">
                                            <!-- 如果分类下只有一个 action，直接显示 action，不显示分类按钮 -->
                                            <template v-if="category.actions.length === 1">
                                                <button v-for="action in category.actions" 
                                                        :key="action.name"
                                                        v-show="!filteredActions || filteredActions.has(action.name)"
                                                        @click="selectAction(action)"
                                                        :class="[
                                                            'w-full text-left px-4 py-2 text-sm transition-colors',
                                                            selectedAction && selectedAction.name === action.name 
                                                                ? 'text-blue-600 font-medium' 
                                                                : 'text-gray-700 hover:text-blue-600'
                                                        ]">
                                                    {{ action.name }}
                                                </button>
                                            </template>
                                            <!-- 如果分类下有多个 action，显示分类按钮 -->
                                            <template v-else>
                                                <button @click="toggleCategory(group.name, category.name)"
                                                        class="w-full text-left px-4 py-2 flex items-center justify-between text-sm text-gray-700 hover:text-gray-900 transition-colors">
                                                    <span>{{ category.name }}</span>
                                                    <svg class="w-4 h-4 text-gray-500 transition-transform duration-200" 
                                                         :class="expandedCategories[`${group.name}-${category.name}`] ? 'rotate-90' : ''"
                                                         fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                                                    </svg>
                                                </button>
                                                
                                                <!-- Actions -->
                                                <div v-show="expandedCategories[`${group.name}-${category.name}`]" class="ml-2 mt-1">
                                                    <button v-for="action in category.actions" 
                                                            :key="action.name"
                                                            v-show="!filteredActions || filteredActions.has(action.name)"
                                                            @click="selectAction(action)"
                                                            :class="[
                                                                'w-full text-left px-4 py-2 text-sm transition-colors',
                                                                selectedAction && selectedAction.name === action.name 
                                                                    ? 'text-blue-600 font-medium' 
                                                                    : 'text-gray-700 hover:text-blue-600'
                                                            ]">
                                                        {{ action.name }}
                                                    </button>
                                                </div>
                                            </template>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div v-else-if="loadError" class="text-red-600 text-sm text-center py-8">
                        <p class="font-medium">文档加载失败</p>
                        <p class="text-xs mt-2">{{ loadError }}</p>
                        <p class="text-xs mt-2 text-gray-500">请检查浏览器控制台获取详细信息</p>
                    </div>
                    <div v-else-if="docData && (!docData.files || docData.files.length === 0)" class="text-gray-500 text-sm text-center py-8">
                        <p>文档数据格式错误：缺少 files 字段</p>
                        <p class="text-xs mt-2">请检查 JSON 文档格式</p>
                    </div>
                    <div v-else class="text-gray-500 text-sm text-center py-8">
                        <p>加载中...</p>
                        <p class="text-xs mt-2">如果长时间未加载，请检查浏览器控制台</p>
                    </div>
                </div>
            </div>

            <!-- 右侧内容区域 -->
            <div class="flex-1 overflow-y-auto custom-scrollbar bg-gray-50">
                <!-- 搜索框（始终显示在顶部） -->
                <div class="sticky p-6 max-w-4xl mx-auto">
                    <div class="max-w-4xl mx-auto">
                        <div class="relative">
                            <input v-model="searchQuery"
                                   type="text"
                                   placeholder="搜索 Action（支持前缀搜索，如：user、carl.aicar）..."
                                   class="w-full px-4 py-3 pl-10 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm"
                                   @input="onSearchInput">
                            <svg class="absolute left-3 top-3.5 w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                            </svg>
                            <button v-if="searchQuery"
                                    @click="clearSearch"
                                    class="absolute right-3 top-3.5 text-gray-400 hover:text-gray-600">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- 历史记录标签（搜索栏下方） -->
                <div v-if="getRecentHistoryActions().length > 0" class="px-6 pb-4 max-w-4xl mx-auto">
                    <div class="flex flex-wrap gap-2">
                        <button v-for="item in getRecentHistoryActions()"
                                :key="item.id"
                                @click="applyHistory(item)"
                                class="px-3 py-1.5 text-xs bg-gray-100 hover:bg-blue-100 text-gray-700 hover:text-blue-700 rounded-md transition-colors flex items-center gap-1.5 font-mono">
                            <span v-if="item.pinned"
                                  class="flex-shrink-0 text-yellow-600">
                                <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
                                    <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/>
                                </svg>
                            </span>
                            <span>{{ item.action }}</span>
                        </button>
                    </div>
                </div>
                
                <div v-if="selectedAction" class="p-6 max-w-4xl mx-auto">
                    <!-- 文档基础信息 -->
                    <div class="bg-white rounded-lg shadow-sm p-6 mb-6">
                        <h1 class="text-2xl font-bold text-gray-900 mb-4">{{ selectedAction.name }}</h1>
                        <div v-if="docData && docData.metadata" class="grid grid-cols-2 gap-4 text-sm mb-4">
                            <div>
                                <span class="text-gray-500">版本:</span>
                                <span class="ml-2 text-gray-900">{{ docData.metadata.version }}</span>
                            </div>
                            <div v-if="docData.metadata.generatedAt">
                                <span class="text-gray-500">更新:</span>
                                <span class="ml-2 text-gray-900">{{ docData.metadata.generatedAt }}</span>
                            </div>
                        </div>
                        <div v-if="docData && docData.info" class="border-t pt-4 mt-4">
                            <div class="text-sm mb-2">
                                <span class="text-gray-500">请求格式:</span>
                                <code class="ml-2 px-2 py-1 bg-gray-100 rounded text-xs">{{ docData.info.requestFormat }}</code>
                            </div>
                            <div class="text-sm">
                                <span class="text-gray-500">响应格式:</span>
                                <code class="ml-2 px-2 py-1 bg-gray-100 rounded text-xs">{{ docData.info.responseFormat }}</code>
                            </div>
                        </div>
                    </div>

                    <!-- 服务器地址和调试按钮 -->
                    <div class="bg-white rounded-lg shadow-sm p-6 mb-6">
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">服务器地址</label>
                            <div class="flex gap-2">
                                <input v-model="serverUrl" 
                                       type="text" 
                                       placeholder="ws://localhost:8080/ws 或 http://localhost:8080/api"
                                       class="flex-1 px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <button @click="saveServer" 
                                        :disabled="!serverUrl"
                                        :class="[
                                            'px-4 py-2 rounded-md font-medium text-white transition-colors text-sm',
                                            !serverUrl 
                                                ? 'bg-gray-400 cursor-not-allowed' 
                                                : 'bg-green-600 hover:bg-green-700'
                                        ]">
                                    保存
                                </button>
                                <button @click="sendRequest" 
                                        :disabled="!serverUrl || isSending"
                                        :class="[
                                            'px-6 py-2 rounded-md font-medium text-white transition-colors',
                                            !serverUrl || isSending 
                                                ? 'bg-gray-400 cursor-not-allowed' 
                                                : 'bg-blue-600 hover:bg-blue-700'
                                        ]">
                                    {{ isSending ? '发送中...' : '发送请求' }}
                                </button>
                            </div>
                        </div>
                        
                        <!-- 已保存的服务器列表 -->
                        <div v-if="savedServers.length > 0" class="mt-4 pt-4 border-t border-gray-200">
                            <label class="block text-sm font-medium text-gray-700 mb-2">已保存的服务器</label>
                            <div class="space-y-2">
                                <div v-for="server in savedServers" 
                                     :key="server.id"
                                     class="flex items-center gap-2 p-2 bg-gray-50 rounded-md hover:bg-gray-100 transition-colors">
                                    <button @click="selectServer(server.url)"
                                            class="flex-1 text-left text-sm text-gray-700 hover:text-blue-600 min-w-0">
                                        <div class="font-medium truncate">{{ server.name || server.url }}</div>
                                        <div class="text-xs text-gray-500 truncate" :title="server.url">{{ server.url }}</div>
                                    </button>
                                    <button @click="startEditServerName(server)"
                                            class="px-2 py-1 text-xs text-gray-600 hover:text-blue-600 hover:bg-blue-50 rounded">
                                        重命名
                                    </button>
                                    <button @click="deleteServer(server.id)"
                                            class="px-2 py-1 text-xs text-red-600 hover:text-red-700 hover:bg-red-50 rounded">
                                        删除
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 重命名服务器对话框 -->
                    <div v-if="editingServerId" 
                         class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50"
                         @click.self="cancelEditServerName">
                        <div class="bg-white rounded-lg shadow-xl p-6 max-w-md w-full mx-4" @click.stop>
                            <h3 class="text-lg font-semibold text-gray-900 mb-4">重命名服务器</h3>
                            <div class="mb-4">
                                <label class="block text-sm font-medium text-gray-700 mb-2">名称</label>
                                <input v-model="editingServerName"
                                       type="text"
                                       placeholder="输入服务器名称"
                                       class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                       @keyup.enter="saveServerName"
                                       @keyup.esc="cancelEditServerName">
                                <p class="text-xs text-gray-500 mt-1">为空则显示地址</p>
                            </div>
                            <div class="flex gap-2 justify-end">
                                <button @click="cancelEditServerName"
                                        class="px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 rounded-md">
                                    取消
                                </button>
                                <button @click="saveServerName"
                                        class="px-4 py-2 text-sm bg-blue-600 text-white rounded-md hover:bg-blue-700">
                                    保存
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 响应结果模态框 -->
                    <div v-if="showResponseModal && response" 
                         class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4"
                         @click.self="closeResponseModal"
                         @keyup.esc="closeResponseModal"
                         tabindex="0">
                        <div class="bg-white rounded-lg shadow-xl w-full max-w-4xl max-h-[90vh] flex flex-col" @click.stop>
                            <!-- 模态框头部 -->
                            <div class="flex items-center justify-between p-6 border-b border-gray-200">
                                <div>
                                    <h3 class="text-lg font-semibold text-gray-900">响应结果</h3>
                                    <div class="mt-1">
                                        <span class="text-sm text-gray-500">状态: </span>
                                        <span :class="[
                                            'text-sm font-medium',
                                            responseStatus === 'success' ? 'text-green-600' : 'text-red-600'
                                        ]">
                                            {{ responseStatus === 'success' ? '成功' : '失败' }}
                                        </span>
                                    </div>
                                </div>
                                <div class="flex gap-2">
                                    <button @click.stop="copyResponse($event)"
                                            class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 text-sm font-medium flex items-center gap-2">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/>
                                        </svg>
                                        复制 JSON
                                    </button>
                                    <button @click.stop="closeResponseModal"
                                            class="p-2 text-gray-400 hover:text-gray-600 rounded-md hover:bg-gray-100">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                                        </svg>
                                    </button>
                                </div>
                            </div>
                            
                            <!-- 错误提示 -->
                            <div v-if="responseStatus === 'error' && response.msg" 
                                 class="mx-6 mt-4 p-3 bg-red-50 border border-red-200 rounded-md">
                                <div class="flex items-start">
                                    <svg class="w-5 h-5 text-red-600 mt-0.5 mr-2 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/>
                                    </svg>
                                    <div class="flex-1">
                                        <p class="text-sm font-medium text-red-800">错误信息</p>
                                        <p class="text-sm text-red-700 mt-1">{{ response.msg }}</p>
                                        <p v-if="response.code" class="text-xs text-red-600 mt-1">错误码: {{ response.code }}</p>
                                    </div>
                                </div>
                            </div>
                            <div v-else-if="responseStatus === 'error' && response.error" 
                                 class="mx-6 mt-4 p-3 bg-red-50 border border-red-200 rounded-md">
                                <div class="flex items-start">
                                    <svg class="w-5 h-5 text-red-600 mt-0.5 mr-2 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/>
                                    </svg>
                                    <div class="flex-1">
                                        <p class="text-sm font-medium text-red-800">错误</p>
                                        <p class="text-sm text-red-700 mt-1">{{ response.error }}</p>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 响应内容 -->
                            <div class="flex-1 overflow-y-auto p-6">
                                <pre class="bg-gray-50 p-4 rounded-md overflow-x-auto text-xs"><code>{{ formattedResponse }}</code></pre>
                            </div>
                        </div>
                    </div>

                    <!-- 参数表单 -->
                    <div class="bg-white rounded-lg shadow-sm p-6 mb-6">
                        <div class="flex items-center justify-between mb-4">
                            <h2 class="text-lg font-semibold text-gray-900">请求参数</h2>
                            <div class="flex items-center gap-2">
                                <button v-if="selectedAction.params && selectedAction.params.length > 0"
                                        @click="toggleParamsEditMode"
                                        class="px-3 py-1 text-sm text-blue-600 hover:text-blue-800 border border-blue-300 rounded-md hover:bg-blue-50">
                                    {{ paramsEditMode === 'form' ? '切换到 JSON 编辑' : '切换到表单编辑' }}
                                </button>
                            </div>
                        </div>
                        
                        <!-- 表单模式 -->
                        <div v-if="paramsEditMode === 'form'">
                            <div v-if="selectedAction.params && selectedAction.params.length > 0" class="space-y-4">
                                <div v-for="param in selectedAction.params" :key="param.Name" class="border-b border-gray-100 pb-4 last:border-0 last:pb-0">
                                    <label class="block text-sm font-medium text-gray-700 mb-2">
                                        {{ param.Name }}
                                        <span v-if="param.Required" class="text-red-500 ml-1">*</span>
                                        <span class="text-gray-400 text-xs ml-2">({{ param.Type }})</span>
                                    </label>
                                    <input v-if="param.Type === 'string' || param.Type === 'int' || param.Type === 'float'"
                                           v-model="formData[param.Name]"
                                           :type="param.Type === 'int' || param.Type === 'float' ? 'number' : 'text'"
                                           :placeholder="getPlaceholder(param)"
                                           class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    <input v-else-if="param.Type === 'bool'"
                                           type="checkbox"
                                           v-model="formData[param.Name]"
                                           class="w-5 h-5 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                                    <textarea v-else
                                              v-model="formData[param.Name]"
                                              :placeholder="getPlaceholder(param)"
                                              rows="3"
                                              class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                                    <p v-if="param.Description" class="text-xs text-gray-500 mt-1">{{ param.Description }}</p>
                                    <button v-if="selectedAction.example && selectedAction.example.request && selectedAction.example.request.params[param.Name] !== undefined"
                                            @click="fillExampleValue(param.Name)"
                                            class="mt-1 text-xs text-blue-600 hover:text-blue-800">
                                        使用示例值: {{ JSON.stringify(selectedAction.example.request.params[param.Name]) }}
                                    </button>
                                </div>
                            </div>
                            <div v-else class="text-gray-500 text-sm">此接口无需参数</div>
                        </div>
                        
                        <!-- JSON 编辑模式 -->
                        <div v-else>
                            <div class="mb-2">
                                <label class="block text-sm font-medium text-gray-700 mb-2">直接编辑 JSON 格式的 params 对象：</label>
                                <textarea v-model="jsonParamsText"
                                          @blur="parseJsonParams"
                                          placeholder='{"page": {"current": 1, "pageSize": 10}}'
                                          rows="8"
                                          class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 font-mono text-sm"></textarea>
                                <p v-if="jsonParamsError" class="text-xs text-red-500 mt-1">{{ jsonParamsError }}</p>
                                <p class="text-xs text-gray-500 mt-1">提示：可以直接粘贴 JSON 格式的 params 对象</p>
                            </div>
                        </div>
                    </div>

                    <!-- 请求预览 -->
                    <div class="bg-white rounded-lg shadow-sm p-6 mb-6">
                        <h2 class="text-lg font-semibold text-gray-900 mb-4">请求预览</h2>
                        <pre class="bg-gray-50 p-4 rounded-md overflow-x-auto text-xs"><code>{{ requestPreview }}</code></pre>
                    </div>

                    <!-- 错误码说明 -->
                    <div v-if="selectedAction.errorCodes && selectedAction.errorCodes.length > 0" 
                         class="bg-white rounded-lg shadow-sm p-6 mb-6">
                        <h2 class="text-lg font-semibold text-gray-900 mb-4">错误码</h2>
                        <div class="space-y-2">
                            <div v-for="error in selectedAction.errorCodes" :key="error.Code" 
                                 class="flex items-center gap-4 text-sm">
                                <span class="font-mono text-red-600 w-20">{{ error.Code }}</span>
                                <span class="text-gray-700">{{ error.Message }}</span>
                            </div>
                        </div>
                    </div>

                    <!-- Action 详细信息 -->
                    <div class="bg-white rounded-lg shadow-sm p-6 mb-6">
                        <h2 class="text-lg font-semibold text-gray-900 mb-4">接口信息</h2>
                        <div class="space-y-3 text-sm">
                            <div>
                                <span class="text-gray-500">接口名称:</span>
                                <span class="ml-2 text-gray-900 font-mono">{{ selectedAction.name }}</span>
                            </div>
                            <div v-if="selectedAction.description">
                                <span class="text-gray-500">描述:</span>
                                <span class="ml-2 text-gray-900">{{ selectedAction.description || '无' }}</span>
                            </div>
                            <div>
                                <span class="text-gray-500">认证要求:</span>
                                <span class="ml-2 text-gray-900">{{ selectedAction.authRequirement }}</span>
                            </div>
                            <div v-if="selectedAction.returns">
                                <span class="text-gray-500">返回类型:</span>
                                <span class="ml-2 text-gray-900">{{ selectedAction.returns.successType || 'N/A' }}</span>
                                <span class="ml-2 text-gray-500">({{ selectedAction.returns.hasData ? '有数据' : '无数据' }})</span>
                            </div>
                        </div>
                    </div>

                    <!-- 响应结果按钮（点击打开模态框） -->
                    <div v-if="response" class="bg-white rounded-lg shadow-sm p-6">
                        <div class="flex items-center justify-between mb-4">
                            <h2 class="text-lg font-semibold text-gray-900">响应结果</h2>
                            <button @click="showResponseModal = true"
                                    class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 text-sm font-medium">
                                查看响应
                            </button>
                        </div>
                        <div class="mb-2">
                            <span class="text-sm text-gray-500">状态: </span>
                            <span :class="[
                                'text-sm font-medium',
                                responseStatus === 'success' ? 'text-green-600' : 'text-red-600'
                            ]">
                                {{ responseStatus === 'success' ? '成功' : '失败' }}
                            </span>
                        </div>
                        <div v-if="responseStatus === 'error' && response.msg" class="mt-2 p-2 bg-red-50 border border-red-200 rounded text-sm text-red-700">
                            {{ response.msg }}
                        </div>
                    </div>
                </div>

                <!-- 未选择 Action 时的提示和更新日志 -->
                <div v-else class="p-6 max-w-4xl mx-auto">
                    <!-- 历史记录 -->
                    <div class="bg-white rounded-lg shadow-sm p-6 mb-6">
                        <div class="flex items-center justify-between mb-4">
                            <h2 class="text-lg font-semibold text-gray-900">历史记录</h2>
                            <div class="flex gap-2">
                                <input v-model="historyFilter"
                                       type="text"
                                       placeholder="搜索历史记录..."
                                       class="px-3 py-1 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <button v-if="requestHistory.length > 0"
                                        @click="clearHistory"
                                        class="px-3 py-1 text-xs text-red-600 hover:text-red-700 hover:bg-red-50 rounded">
                                    清空
                                </button>
                            </div>
                        </div>
                        <div v-if="getFilteredHistory().length > 0" class="flex flex-wrap gap-2">
                            <div v-for="item in getFilteredHistory()" 
                                 :key="item.id"
                                 class="flex items-center gap-2">
                                <button @click="applyHistory(item)"
                                        class="px-3 py-2 bg-gray-100 hover:bg-blue-100 text-sm text-gray-700 hover:text-blue-700 rounded-md transition-colors flex items-center gap-2">
                                    <span @click.stop="pinHistory(item.id)"
                                          :class="[
                                              'flex-shrink-0 transition-colors cursor-pointer',
                                              item.pinned 
                                                  ? 'text-yellow-600 hover:text-yellow-700' 
                                                  : 'text-gray-400 hover:text-yellow-600'
                                          ]"
                                          :title="item.pinned ? '取消置顶' : '置顶'">
                                        <svg class="w-3.5 h-3.5" fill="currentColor" viewBox="0 0 20 20">
                                            <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/>
                                        </svg>
                                    </span>
                                    <span class="font-mono text-xs">{{ item.action }}</span>
                                    <span @click.stop="deleteHistory(item.id)"
                                          class="flex-shrink-0 transition-colors cursor-pointer text-red-500 hover:text-red-700 ml-auto"
                                          title="删除">
                                        ×
                                    </span>
                                </button>
                            </div>
                        </div>
                        <div v-else class="text-gray-500 text-sm">
                            <span v-if="historyFilter">未找到匹配的历史记录</span>
                            <span v-else>暂无历史记录</span>
                        </div>
                    </div>
                    
                    <!-- 更新日志 -->
                    <div v-if="docData && docData.changelog" class="bg-white rounded-lg shadow-sm p-6 mb-6">
                        <h2 class="text-xl font-semibold text-gray-900 mb-4">接口更新日志</h2>
                        <div class="space-y-4">
                            <div class="flex items-center gap-4 text-sm text-gray-600 mb-4 pb-4 border-b">
                                <span><strong>版本:</strong> {{ docData.changelog.version }}</span>
                                <span><strong>更新时间:</strong> {{ docData.changelog.timestamp }}</span>
                            </div>
                            
                            <div v-if="docData.changelog.added && docData.changelog.added.length > 0" class="space-y-2">
                                <h3 class="text-sm font-semibold text-green-700 flex items-center gap-2">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
                                    </svg>
                                    新增接口 ({{ docData.changelog.added.length }})
                                </h3>
                                <div class="grid grid-cols-2 md:grid-cols-3 gap-2">
                                    <button v-for="actionName in docData.changelog.added" 
                                            :key="actionName"
                                            @click="selectActionByName(actionName)"
                                            class="text-left px-3 py-2 text-sm bg-green-50 hover:bg-green-100 border border-green-200 rounded-md text-green-800 hover:text-green-900 transition-colors">
                                        {{ actionName }}
                                    </button>
                                </div>
                            </div>
                            
                            <div v-if="docData.changelog.removed && docData.changelog.removed.length > 0" class="space-y-2">
                                <h3 class="text-sm font-semibold text-red-700 flex items-center gap-2">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                                    </svg>
                                    删除接口 ({{ docData.changelog.removed.length }})
                                </h3>
                                <div class="grid grid-cols-2 md:grid-cols-3 gap-2">
                                    <div v-for="actionName in docData.changelog.removed" 
                                         :key="actionName"
                                         class="px-3 py-2 text-sm bg-red-50 border border-red-200 rounded-md text-red-600 line-through">
                                        {{ actionName }}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 提示信息 -->
                    <div class="text-center text-gray-500">
                        <svg class="mx-auto h-12 w-12 text-gray-400 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                        </svg>
                        <p class="text-lg">请从左侧选择一个 API 接口</p>
                        <p v-if="!docData || !docData.changelog" class="text-sm mt-2">或查看上方的接口更新日志</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- JSON 数据通过 API 端点动态加载，不再嵌入到 HTML 中 -->

    <script>
        // 确保 Vue 库和 DOM 都加载完成后再初始化
        window.addEventListener('load', function() {
            // 等待 Vue 库加载
            function initVue() {
                if (typeof Vue === 'undefined') {
                    console.error('Vue 库未加载，请检查 CDN 连接');
                    // 启动阶段保持仅显示 Loading，避免闪现错误弹窗/模态框等干扰体验
                    return;
                }

                try {
                    const { createApp } = Vue;
                    const app = document.getElementById('app');
                    if (!app) {
                        console.error('找不到 #app 元素');
                        return;
                    }

                    createApp({
            data() {
                return {
                    docData: null,
                    selectedAction: null,
                    expandedGroups: {},
                    expandedCategories: {},
                    formData: {},
                    serverUrl: '',
                    response: null,
                    responseStatus: null,
                    isSending: false,
                    availableDocs: [],
                    currentDocName: 'action',
                    docs: {}, // 存储所有文档数据
                    loadError: null, // 加载错误信息
                    savedServers: [], // 已保存的服务器地址列表
                    editingServerId: null, // 正在编辑名称的服务器 ID
                    editingServerName: '', // 正在编辑的名称
                    menuOpen: false, // 菜单是否打开（小屏幕，默认关闭）
                    showResponseModal: false, // 是否显示响应模态框
                    prefixTree: {}, // 前缀树结构
                    selectedPrefix: null, // 当前选中的前缀
                    expandedPrefixes: {}, // 展开的前缀节点
                    requestHistory: [], // 请求历史记录
                    historyFilter: '', // 历史记录搜索过滤
                    searchQuery: '', // 搜索框输入
                    searchMatchedActions: null, // 搜索匹配的 action 集合
                    allActions: [], // 所有 action 列表（用于搜索）
                    paramsEditMode: 'json', // 参数编辑模式：'form' 或 'json'
                    jsonParamsText: '', // JSON 编辑模式的文本内容
                    jsonParamsError: '', // JSON 解析错误信息
                    currentWebSocket: null, // 当前 WebSocket 连接
                    currentWebSocketUrl: '', // 当前 WebSocket 连接的 URL
                    wsReconnectTimer: null // WebSocket 重连定时器
                };
            },
            computed: {
                requestPreview() {
                    if (!this.selectedAction) return '';
                    
                    let params = {};
                    
                    if (this.paramsEditMode === 'json') {
                        // JSON 模式：直接使用解析后的 JSON
                        try {
                            if (this.jsonParamsText.trim()) {
                                params = JSON.parse(this.jsonParamsText);
                            }
                        } catch (e) {
                            // 如果 JSON 解析失败，返回错误提示
                            return JSON.stringify({
                                action: this.selectedAction.name,
                                params: {},
                                error: 'JSON 格式错误，请检查输入'
                            }, null, 2);
                        }
                    } else {
                        // 表单模式：从 formData 构建嵌套对象
                        for (const param of this.selectedAction.params || []) {
                            const value = this.formData[param.Name];
                            if (value !== undefined && value !== null && value !== '') {
                                // 检查参数名是否包含点号（如 "page.current"）
                                if (param.Name.includes('.')) {
                                    const parts = param.Name.split('.');
                                    const parentKey = parts[0];
                                    const childKey = parts.slice(1).join('.');
                                    
                                    // 如果父键不存在，创建嵌套对象
                                    if (!params[parentKey]) {
                                        params[parentKey] = {};
                                    }
                                    
                                    // 类型转换
                                    let convertedValue = value;
                                    if (param.Type === 'int') {
                                        convertedValue = parseInt(value);
                                    } else if (param.Type === 'float') {
                                        convertedValue = parseFloat(value);
                                    } else if (param.Type === 'bool') {
                                        convertedValue = Boolean(value);
                                    }
                                    
                                    // 将子字段添加到嵌套对象中
                                    this.setNestedValue(params[parentKey], childKey, convertedValue);
                                } else {
                                    // 普通字段，直接添加
                                    let convertedValue = value;
                                    if (param.Type === 'int') {
                                        convertedValue = parseInt(value);
                                    } else if (param.Type === 'float') {
                                        convertedValue = parseFloat(value);
                                    } else if (param.Type === 'bool') {
                                        convertedValue = Boolean(value);
                                    }
                                    params[param.Name] = convertedValue;
                                }
                            } else if (param.Required) {
                                // 必填但未填，根据是否有嵌套结构处理
                                if (param.Name.includes('.')) {
                                    const parts = param.Name.split('.');
                                    const parentKey = parts[0];
                                    const childKey = parts.slice(1).join('.');
                                    
                                    if (!params[parentKey]) {
                                        params[parentKey] = {};
                                    }
                                    params[parentKey][childKey] = null;
                                } else {
                                    params[param.Name] = null;
                                }
                            }
                        }
                    }
                    
                    return JSON.stringify({
                        action: this.selectedAction.name,
                        params: params
                    }, null, 2);
                },
                formattedResponse() {
                    if (!this.response) return '';
                    return JSON.stringify(this.response, null, 2);
                },
                filteredActions() {
                    // 如果有搜索结果，优先使用搜索匹配
                    if (this.searchMatchedActions && this.searchMatchedActions.size > 0) {
                        return this.searchMatchedActions;
                    }
                    // 如果没有选中前缀或文档数据，返回 null 表示不过滤
                    if (!this.selectedPrefix || !this.docData || !this.docData.files) {
                        return null;
                    }
                    
                    // 收集所有匹配的 action 名称（基于前缀选择）
                    const matchedActions = new Set();
                    
                    // 递归收集前缀树中匹配的 actions
                    const collectActions = (tree) => {
                        if (tree.actions) {
                            tree.actions.forEach(action => matchedActions.add(action));
                        }
                        if (tree.children) {
                            Object.keys(tree.children).forEach(key => {
                                collectActions(tree.children[key]);
                            });
                        }
                    };
                    
                    // 从根开始查找匹配的前缀路径
                    const findPrefixPath = (parts, tree) => {
                        if (parts.length === 0) {
                            collectActions(tree);
                            return;
                        }
                        const first = parts[0];
                        if (tree.children && tree.children[first]) {
                            findPrefixPath(parts.slice(1), tree.children[first]);
                        }
                    };
                    
                    const prefixParts = this.selectedPrefix.split('.');
                    findPrefixPath(prefixParts, this.prefixTree);
                    
                    return matchedActions;
                }
            },
            mounted() {
                // 启动阶段：先完成必要初始化，再显示完整页面（避免未完成时出现错误/模态框）
                (async () => {
                    // 从注入配置发现并加载文档（内部会设置 loadError）
                    await this.discoverDocuments();
                    // 从 localStorage 加载已保存的服务器地址（需要在 discoverDocuments 之后，因为需要 currentDocName）
                    this.loadSavedServers();
                    // 从 localStorage 加载历史记录（需要在 discoverDocuments 之后，因为需要 currentDocName）
                    this.loadFromHistory();

                    // 标记应用已就绪：隐藏 Loading，显示页面
                    document.body.classList.add('app-ready');
                })();
                
                // 添加全局 ESC 键监听，用于关闭模态框
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape') {
                        if (this.showResponseModal) {
                            this.closeResponseModal();
                        }
                        if (this.editingServerId) {
                            this.cancelEditServerName();
                        }
                    }
                });
            },
            methods: {
                async discoverDocuments() {
                    // 从注入的配置中获取可用文档列表
                    try {
                        const docsList = window.__DOCS_CONFIG__ || [];
                        
                        this.availableDocs = docsList.map(doc => ({
                            name: doc.name,
                            label: doc.label,
                            url: doc.file || doc.url
                        }));
                        
                        console.log('发现文档:', this.availableDocs.map(d => `${d.name} (${d.label})`));
                        
                        // 设置默认文档（优先从 localStorage 加载最后选择的文档，否则优先 action，最后选择第一个）
                        if (this.availableDocs.length > 0) {
                            // 尝试从 localStorage 加载最后选择的文档
                            const savedDocName = localStorage.getItem('lastSelectedDoc');
                            let defaultDoc = null;
                            
                            if (savedDocName) {
                                defaultDoc = this.availableDocs.find(d => d.name === savedDocName);
                            }
                            
                            // 如果保存的文档不存在，使用默认逻辑
                            if (!defaultDoc) {
                                defaultDoc = this.availableDocs.find(d => d.name === 'action') || this.availableDocs[0];
                            }
                            
                            this.currentDocName = defaultDoc.name;
                            console.log('设置默认文档为:', this.currentDocName);
                            
                            // 保存最后选择的文档
                            this.saveLastSelectedDoc();
                            
                            // 加载默认文档
                            await this.loadDocument();
                        } else {
                            console.warn('未发现任何文档');
                            this.loadError = '未找到任何文档文件。请确保已运行文档生成命令。';
                        }
                    } catch (error) {
                        console.error('发现文档失败:', error);
                        this.loadError = `无法获取文档列表: ${error.message}`;
                    }
                },
                async loadDocument() {
                    console.log('开始加载文档，currentDocName:', this.currentDocName);
                    this.loadError = null; // 清除之前的错误
                    
                    if (!this.currentDocName) {
                        this.loadError = '文档名称为空，无法加载文档';
                        return;
                    }
                    
                    // 1. 优先从缓存的文档数据中加载（最快）
                    if (this.docs[this.currentDocName]) {
                        console.log('从缓存加载文档:', this.currentDocName);
                        this.docData = this.docs[this.currentDocName];
                        this.initializeExpandedState();
                        this.buildPrefixTree(); // 构建前缀树
                        this.selectedAction = null;
                        this.formData = {};
                        this.response = null;
                        console.log('文档加载成功（从缓存）:', this.docData.files ? this.docData.files.length : 0, '个文件');
                        return;
                    }
                    
                    // 2. 从 API 端点加载文档
                    const docInfo = this.availableDocs.find(d => d.name === this.currentDocName);
                    if (!docInfo) {
                        const errorMsg = `文档 "${this.currentDocName}" 不存在。可用的文档: ${this.availableDocs.map(d => d.name).join(', ') || '无'}`;
                        console.error(errorMsg);
                        this.loadError = errorMsg;
                        this.docData = null;
                        return;
                    }
                    
                    try {
                        console.log('从 API 端点加载文档:', docInfo.url);
                        const response = await fetch(docInfo.url);
                        if (!response.ok) {
                            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                        }
                        
                        const data = await response.json();
                        if (data && typeof data === 'object' && data.files) {
                            this.docData = data;
                            this.docs[this.currentDocName] = data; // 缓存
                            this.initializeExpandedState();
                            this.buildPrefixTree(); // 构建前缀树
                            this.selectedAction = null;
                            this.formData = {};
                            this.response = null;
                            console.log('文档加载成功（从 API）:', data.files.length, '个文件');
                        } else {
                            throw new Error('文档数据格式错误：缺少 files 字段');
                        }
                    } catch (error) {
                        console.error('加载文档失败:', error);
                        this.loadError = `无法加载文档 "${this.currentDocName}": ${error.message}`;
                        this.docData = null;
                    }
                },
                initializeExpandedState() {
                    // 默认所有分组和分类都折叠
                    // 注意：如果分类下只有一个 action，不需要初始化展开状态（因为不会显示分类按钮）
                    if (this.docData && this.docData.files) {
                        this.docData.files.forEach(file => {
                            file.middlewareGroups.forEach(group => {
                                this.expandedGroups[group.name] = false;
                                group.categories.forEach(category => {
                                    // 只有当分类下有多个 action 时，才需要初始化展开状态
                                    if (category.actions.length > 1) {
                                        this.expandedCategories[`${group.name}-${category.name}`] = false;
                                    }
                                });
                            });
                        });
                    }
                },
                toggleGroup(groupName) {
                    this.expandedGroups[groupName] = !this.expandedGroups[groupName];
                },
                toggleCategory(groupName, categoryName) {
                    const key = `${groupName}-${categoryName}`;
                    this.expandedCategories[key] = !this.expandedCategories[key];
                },
                selectAction(action) {
                    this.selectedAction = action;
                    this.formData = {};
                    this.response = null;
                    this.responseStatus = null;
                    this.paramsEditMode = 'json'; // 重置为 JSON 模式
                    this.jsonParamsError = ''; // 清空错误信息
                    // 小屏幕下选择 action 后自动关闭菜单
                    if (window.innerWidth < 768) {
                        this.menuOpen = false;
                    }

                    // 初始化表单数据，不填入默认参数
                    if (action.params) {
                        action.params.forEach(param => {
                            // 根据类型设置默认值（不填入示例值）
                            if (param.Type === 'bool') {
                                this.formData[param.Name] = false;
                            } else if (param.Type === 'int' || param.Type === 'uint' || param.Type === 'int32' || param.Type === 'uint32' || param.Type === 'int64' || param.Type === 'uint64') {
                                this.formData[param.Name] = 0;
                            } else if (param.Type === 'float' || param.Type === 'float32' || param.Type === 'float64') {
                                this.formData[param.Name] = 0;
                            } else {
                                this.formData[param.Name] = '';
                            }
                        });
                    }
                    
                    // 如果有示例数据，自动填充到 JSON 文本框中
                    if (action.example && action.example.request && action.example.request.params) {
                        this.jsonParamsText = JSON.stringify(action.example.request.params, null, 2);
                    } else {
                        this.jsonParamsText = '{}';
                    }
                },
                selectActionByName(actionName) {
                    // 从文档数据中查找指定名称的 action
                    if (!this.docData || !this.docData.files) {
                        return;
                    }
                    
                    for (const file of this.docData.files) {
                        for (const group of file.middlewareGroups || []) {
                            for (const category of group.categories || []) {
                                for (const action of category.actions || []) {
                                    if (action.name === actionName) {
                                        this.selectAction(action);
                                        // 滚动到顶部
                                        window.scrollTo({ top: 0, behavior: 'smooth' });
                                        return;
                                    }
                                }
                            }
                        }
                    }
                },
                getPlaceholder(param) {
                    if (param.Type === 'int') return '请输入整数';
                    if (param.Type === 'float') return '请输入数字';
                    if (param.Type === 'bool') return '';
                    return '请输入' + param.Name;
                },
                fillExampleValue(paramName) {
                    if (this.selectedAction.example && this.selectedAction.example.request) {
                        const value = this.selectedAction.example.request.params[paramName];
                        this.formData[paramName] = value;
                    }
                },
                toggleParamsEditMode() {
                    if (this.paramsEditMode === 'form') {
                        // 切换到 JSON 模式
                        // 如果 JSON 文本已经有内容且是有效的 JSON，保留它
                        // 否则从表单数据构建 JSON
                        let shouldBuildFromForm = true;
                        if (this.jsonParamsText.trim()) {
                            try {
                                JSON.parse(this.jsonParamsText);
                                // JSON 有效，保留现有内容
                                shouldBuildFromForm = false;
                            } catch (e) {
                                // JSON 无效，从表单构建
                                shouldBuildFromForm = true;
                            }
                        }
                        
                        if (shouldBuildFromForm) {
                            const params = {};
                            for (const param of this.selectedAction.params || []) {
                                const value = this.formData[param.Name];
                                if (value !== undefined && value !== null && value !== '') {
                                    // 检查参数名是否包含点号（如 "page.current"）
                                    if (param.Name.includes('.')) {
                                        const parts = param.Name.split('.');
                                        const parentKey = parts[0];
                                        const childKey = parts.slice(1).join('.');
                                        
                                        if (!params[parentKey]) {
                                            params[parentKey] = {};
                                        }
                                        
                                        let convertedValue = value;
                                        if (param.Type === 'int') {
                                            convertedValue = parseInt(value);
                                        } else if (param.Type === 'float') {
                                            convertedValue = parseFloat(value);
                                        } else if (param.Type === 'bool') {
                                            convertedValue = Boolean(value);
                                        }
                                        
                                        this.setNestedValue(params[parentKey], childKey, convertedValue);
                                    } else {
                                        let convertedValue = value;
                                        if (param.Type === 'int') {
                                            convertedValue = parseInt(value);
                                        } else if (param.Type === 'float') {
                                            convertedValue = parseFloat(value);
                                        } else if (param.Type === 'bool') {
                                            convertedValue = Boolean(value);
                                        }
                                        params[param.Name] = convertedValue;
                                    }
                                }
                            }
                            this.jsonParamsText = JSON.stringify(params, null, 2);
                        }
                        this.paramsEditMode = 'json';
                    } else {
                        // 切换到表单模式：从 JSON 解析并填充表单
                        this.parseJsonParams();
                        this.paramsEditMode = 'form';
                    }
                },
                parseJsonParams() {
                    this.jsonParamsError = '';
                    if (!this.jsonParamsText.trim()) {
                        // 如果 JSON 为空，初始化表单为默认值
                        if (this.selectedAction && this.selectedAction.params) {
                            this.selectedAction.params.forEach(param => {
                                if (param.Type === 'bool') {
                                    this.formData[param.Name] = false;
                                } else if (param.Type === 'int' || param.Type === 'uint' || param.Type === 'int32' || param.Type === 'uint32' || param.Type === 'int64' || param.Type === 'uint64') {
                                    this.formData[param.Name] = 0;
                                } else if (param.Type === 'float' || param.Type === 'float32' || param.Type === 'float64') {
                                    this.formData[param.Name] = 0;
                                } else {
                                    this.formData[param.Name] = '';
                                }
                            });
                        } else {
                            this.formData = {};
                        }
                        return;
                    }
                    
                    try {
                        const params = JSON.parse(this.jsonParamsText);
                        
                        // 将嵌套对象转换为表单数据（点号分隔的字段名）
                        for (const param of this.selectedAction.params || []) {
                            if (param.Name.includes('.')) {
                                const parts = param.Name.split('.');
                                const parentKey = parts[0];
                                const childKey = parts.slice(1).join('.');
                                
                                if (params[parentKey] && typeof params[parentKey] === 'object') {
                                    const value = this.getNestedValue(params[parentKey], childKey);
                                    if (value !== undefined) {
                                        this.formData[param.Name] = value;
                                    }
                                }
                            } else {
                                if (params[param.Name] !== undefined) {
                                    this.formData[param.Name] = params[param.Name];
                                }
                            }
                        }
                    } catch (e) {
                        this.jsonParamsError = 'JSON 格式错误: ' + e.message;
                    }
                },
                setNestedValue(obj, path, value) {
                    const parts = path.split('.');
                    let current = obj;
                    for (let i = 0; i < parts.length - 1; i++) {
                        const key = parts[i];
                        if (!current[key] || typeof current[key] !== 'object') {
                            current[key] = {};
                        }
                        current = current[key];
                    }
                    current[parts[parts.length - 1]] = value;
                },
                getNestedValue(obj, path) {
                    const parts = path.split('.');
                    let current = obj;
                    for (const part of parts) {
                        if (current === null || current === undefined || typeof current !== 'object') {
                            return undefined;
                        }
                        current = current[part];
                    }
                    return current;
                },
                async sendRequest() {
                    if (!this.serverUrl || !this.selectedAction) return;
                    
                    // 构建请求参数
                    let params = {};
                    
                    if (this.paramsEditMode === 'json') {
                        // JSON 模式：直接使用解析后的 JSON
                        try {
                            if (this.jsonParamsText.trim()) {
                                params = JSON.parse(this.jsonParamsText);
                            }
                        } catch (e) {
                            this.response = { error: 'JSON 格式错误: ' + e.message };
                            this.responseStatus = 'error';
                            return;
                        }
                    } else {
                        // 表单模式：从 formData 构建嵌套对象
                        for (const param of this.selectedAction.params || []) {
                            const value = this.formData[param.Name];
                            if (value !== undefined && value !== null && value !== '') {
                                // 检查参数名是否包含点号（如 "page.current"）
                                if (param.Name.includes('.')) {
                                    const parts = param.Name.split('.');
                                    const parentKey = parts[0];
                                    const childKey = parts.slice(1).join('.');
                                    
                                    if (!params[parentKey]) {
                                        params[parentKey] = {};
                                    }
                                    
                                    let convertedValue = value;
                                    if (param.Type === 'int') {
                                        convertedValue = parseInt(value);
                                    } else if (param.Type === 'float') {
                                        convertedValue = parseFloat(value);
                                    } else if (param.Type === 'bool') {
                                        convertedValue = Boolean(value);
                                    }
                                    
                                    this.setNestedValue(params[parentKey], childKey, convertedValue);
                                } else {
                                    let convertedValue = value;
                                    if (param.Type === 'int') {
                                        convertedValue = parseInt(value);
                                    } else if (param.Type === 'float') {
                                        convertedValue = parseFloat(value);
                                    } else if (param.Type === 'bool') {
                                        convertedValue = Boolean(value);
                                    }
                                    params[param.Name] = convertedValue;
                                }
                            }
                        }
                    }
                    
                    const requestBody = {
                        action: this.selectedAction.name,
                        params: params
                    };
                    
                    this.isSending = true;
                    this.response = null;
                    this.responseStatus = null;
                    
                    try {
                        // 判断是 WebSocket 还是 HTTP
                        if (this.serverUrl.startsWith('ws://') || this.serverUrl.startsWith('wss://')) {
                            // WebSocket 请求
                            await this.sendWebSocketRequest(this.serverUrl, requestBody);
                        } else {
                            // HTTP 请求
                            await this.sendHttpRequest(this.serverUrl, requestBody);
                        }
                    } catch (error) {
                        this.response = { error: error.message };
                        this.responseStatus = 'error';
                    } finally {
                        this.isSending = false;
                    }
                },
                async sendHttpRequest(url, body) {
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(body)
                    });
                    
                    const data = await response.json();
                    this.response = data;
                    this.responseStatus = response.ok && (data.code === 0 || data.code === 200) ? 'success' : 'error';
                    // 保存到历史记录
                    this.saveToHistory(body.action, body.params, url);
                    // 自动打开响应模态框
                    this.showResponseModal = true;
                },
                async sendWebSocketRequest(url, body) {
                    return new Promise((resolve, reject) => {
                        // 检查是否已有连接且URL相同
                        if (this.currentWebSocket && 
                            this.currentWebSocketUrl === url && 
                            this.currentWebSocket.readyState === WebSocket.OPEN) {
                            // 使用现有连接发送消息
                            this.currentWebSocket.send(JSON.stringify(body));
                            // 保存到历史记录（消息已发送）
                            this.saveToHistory(body.action, body.params, url);
                            resolve();
                            return;
                        }
                        
                        // 如果已有连接但URL不同或已关闭，先关闭旧连接
                        if (this.currentWebSocket) {
                            this.currentWebSocket.close();
                            this.currentWebSocket = null;
                            this.currentWebSocketUrl = '';
                        }
                        
                        // 创建新连接
                        const ws = new WebSocket(url);
                        this.currentWebSocket = ws;
                        this.currentWebSocketUrl = url;
                        let hasReceivedResponse = false;
                        let messageCount = 0;
                        const maxMessages = 10; // 最多处理 10 条消息
                        
                        ws.onopen = () => {
                            ws.send(JSON.stringify(body));
                            resolve(); // 连接打开并发送消息后立即resolve，不等待响应
                        };
                        
                        ws.onmessage = (event) => {
                            try {
                                const data = JSON.parse(event.data);
                                messageCount++;
                                
                                // 检查是否是错误响应
                                if (data.code !== undefined && data.code !== 0 && data.code !== 200) {
                                    // 错误响应
                                    this.response = data;
                                    this.responseStatus = 'error';
                                    hasReceivedResponse = true;
                                    // 保存到历史记录（即使是错误也保存）
                                    this.saveToHistory(body.action, body.params, url);
                                    console.warn('收到错误响应:', data);
                                    // 自动打开响应模态框
                                    this.showResponseModal = true;
                                    // 不关闭连接，保持连接打开
                                    return;
                                }
                                
                                // 成功响应或普通消息
                                this.response = data;
                                this.responseStatus = (data.code === 0 || data.code === 200) ? 'success' : 'error';
                                hasReceivedResponse = true;
                                // 保存到历史记录
                                this.saveToHistory(body.action, body.params, url);
                                // 自动打开响应模态框
                                this.showResponseModal = true;
                                
                                // 不关闭连接，保持连接打开以便后续请求
                            } catch (e) {
                                this.response = { error: '解析响应失败: ' + e.message, raw: event.data };
                                this.responseStatus = 'error';
                                hasReceivedResponse = true;
                                // 自动打开响应模态框
                                this.showResponseModal = true;
                                // 不关闭连接，保持连接打开
                            }
                        };
                        
                        ws.onerror = (error) => {
                            console.error('WebSocket 错误:', error);
                            this.response = { error: 'WebSocket 连接错误，请检查服务器地址和网络连接' };
                            this.responseStatus = 'error';
                            // 连接错误时不关闭，让onclose处理
                        };
                        
                        ws.onclose = (event) => {
                            // 清除当前连接引用
                            if (this.currentWebSocket === ws) {
                                this.currentWebSocket = null;
                                this.currentWebSocketUrl = '';
                            }
                            
                            if (!hasReceivedResponse && ws.readyState !== WebSocket.CLOSING) {
                                // 如果连接关闭但没有收到任何响应，且不是主动关闭
                                if (event.code !== 1000) { // 1000 是正常关闭
                                    this.response = { 
                                        error: `WebSocket 连接异常关闭 (代码: ${event.code})`,
                                        code: event.code,
                                        reason: event.reason || '未知原因'
                                    };
                                } else {
                                    this.response = { error: 'WebSocket 连接已关闭，未收到响应' };
                                }
                                this.responseStatus = 'error';
                            }
                        };
                    });
                },
                loadSavedServers() {
                    try {
                        const key = `savedServers_${this.currentDocName}`;
                        const saved = localStorage.getItem(key);
                        if (saved) {
                            this.savedServers = JSON.parse(saved);
                        } else {
                            this.savedServers = [];
                        }
                    } catch (e) {
                        console.error('加载已保存的服务器失败:', e);
                        this.savedServers = [];
                    }
                },
                saveServersToStorage() {
                    try {
                        const key = `savedServers_${this.currentDocName}`;
                        localStorage.setItem(key, JSON.stringify(this.savedServers));
                    } catch (e) {
                        console.error('保存服务器列表失败:', e);
                    }
                },
                parseUrl(url) {
                    try {
                        // 支持 ws://, wss://, http://, https://
                        const urlObj = new URL(url);
                        const protocol = urlObj.protocol.replace(':', '');
                        let host = urlObj.hostname;
                        let port = urlObj.port;
                        const path = urlObj.pathname;
                        
                        // 如果没有端口，设置默认端口
                        if (!port) {
                            if (protocol === 'ws' || protocol === 'http') {
                                port = '80';
                            } else if (protocol === 'wss' || protocol === 'https') {
                                port = '443';
                            }
                        }
                        
                        return {
                            protocol: protocol,
                            host: host,
                            port: port,
                            path: path || '/'
                        };
                    } catch (e) {
                        console.error('URL 解析失败:', e);
                        return null;
                    }
                },
                saveServer() {
                    if (!this.serverUrl || !this.serverUrl.trim()) {
                        return;
                    }
                    
                    const url = this.serverUrl.trim();
                    const parsed = this.parseUrl(url);
                    
                    if (!parsed) {
                        alert('服务器地址格式错误，无法解析');
                        return;
                    }
                    
                    // 根据 IP、端口、端点判断是否相同
                    const existingIndex = this.savedServers.findIndex(s => {
                        const sParsed = this.parseUrl(s.url);
                        if (!sParsed) return false;
                        return sParsed.host === parsed.host && 
                               sParsed.port === parsed.port && 
                               sParsed.path === parsed.path;
                    });
                    
                    if (existingIndex !== -1) {
                        // 如果已存在，更新现有记录（保留名称）
                        const existing = this.savedServers[existingIndex];
                        existing.url = url; // 更新 URL（可能协议不同）
                        this.saveServersToStorage();
                        console.log('服务器地址已更新:', url);
                    } else {
                        // 如果不存在，插入新记录
                        const id = Date.now().toString();
                        this.savedServers.push({
                            id: id,
                            url: url,
                            name: '' // 默认无名称，显示地址
                        });
                        
                        // 保存到 localStorage
                        this.saveServersToStorage();
                        console.log('服务器地址已保存:', url);
                    }
                },
                selectServer(url) {
                    // 如果切换了服务器地址，且旧地址是WebSocket，关闭旧连接
                    if (this.serverUrl && 
                        (this.serverUrl.startsWith('ws://') || this.serverUrl.startsWith('wss://')) &&
                        this.serverUrl !== url &&
                        this.currentWebSocket) {
                        this.currentWebSocket.close();
                        this.currentWebSocket = null;
                    }
                    this.serverUrl = url;
                },
                deleteServer(id) {
                    if (confirm('确定要删除这个服务器地址吗？')) {
                        // 先检查要删除的服务器是否是当前选中的
                        const server = this.savedServers.find(s => s.id === id);
                        const wasCurrent = server && this.serverUrl === server.url;
                        
                        // 删除服务器
                        this.savedServers = this.savedServers.filter(s => s.id !== id);
                        this.saveServersToStorage();
                        
                        // 如果删除的是当前选中的服务器，清空输入框
                        if (wasCurrent) {
                            this.serverUrl = '';
                        }
                    }
                },
                startEditServerName(server) {
                    this.editingServerId = server.id;
                    this.editingServerName = server.name || '';
                },
                cancelEditServerName() {
                    this.editingServerId = null;
                    this.editingServerName = '';
                },
                saveServerName() {
                    if (this.editingServerId) {
                        const server = this.savedServers.find(s => s.id === this.editingServerId);
                        if (server) {
                            server.name = this.editingServerName.trim();
                            this.saveServersToStorage();
                        }
                        this.cancelEditServerName();
                    }
                },
                closeResponseModal() {
                    this.showResponseModal = false;
                },
                async copyResponse(event) {
                    try {
                        const jsonText = this.formattedResponse;
                        await navigator.clipboard.writeText(jsonText);
                        // 显示成功提示
                        const button = event.target.closest('button');
                        if (button) {
                            const originalText = button.innerHTML;
                            button.innerHTML = '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg> 已复制';
                            button.classList.add('bg-green-600', 'hover:bg-green-700');
                            button.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                            setTimeout(() => {
                                button.innerHTML = originalText;
                                button.classList.remove('bg-green-600', 'hover:bg-green-700');
                                button.classList.add('bg-blue-600', 'hover:bg-blue-700');
                            }, 2000);
                        }
                    } catch (err) {
                        console.error('复制失败:', err);
                        alert('复制失败，请手动选择文本复制');
                    }
                },
                switchToDocument(docName) {
                    if (this.currentDocName === docName) {
                        // 如果点击的是当前文档，不执行任何操作
                        return;
                    }
                    this.currentDocName = docName;
                    this.switchDocument();
                },
                async switchDocument() {
                    // 切换文档：currentDocName 已经通过 v-model 更新
                    console.log('切换文档到:', this.currentDocName);
                    this.loadError = null; // 清除之前的错误
                    
                    if (!this.currentDocName) {
                        const errorMsg = '文档名称为空，无法切换文档';
                        console.error(errorMsg);
                        this.loadError = errorMsg;
                        return;
                    }
                    
                    // 检查文档是否存在
                    const docExists = this.availableDocs.some(doc => doc.name === this.currentDocName);
                    if (!docExists) {
                        const errorMsg = `文档 "${this.currentDocName}" 不存在。可用的文档: ${this.availableDocs.map(d => d.name).join(', ') || '无'}`;
                        console.error('文档不存在:', this.currentDocName);
                        console.log('可用的文档:', this.availableDocs.map(d => d.name));
                        this.loadError = errorMsg;
                        this.docData = null; // 清除旧数据
                        return;
                    }
                    
                    // 保存最后选择的文档
                    this.saveLastSelectedDoc();
                    
                    // 加载文档
                    await this.loadDocument();
                    // 加载对应文档的历史记录
                    this.loadFromHistory();
                    // 加载对应文档的服务器列表
                    this.loadSavedServers();
                },
                saveLastSelectedDoc() {
                    try {
                        if (this.currentDocName) {
                            localStorage.setItem('lastSelectedDoc', this.currentDocName);
                        }
                    } catch (e) {
                        console.error('保存最后选择的文档失败:', e);
                    }
                },
                buildPrefixTree() {
                    if (!this.docData || !this.docData.files) {
                        this.prefixTree = {};
                        this.allActions = [];
                        return;
                    }
                    
                    const tree = { children: {}, actions: [] };
                    const actions = [];
                    
                    // 遍历所有文件、中间件组、分类和 action
                    this.docData.files.forEach(file => {
                        file.middlewareGroups.forEach(group => {
                            group.categories.forEach(category => {
                                category.actions.forEach(action => {
                                    const actionName = action.name;
                                    const parts = actionName.split('.');
                                    
                                    // 收集所有 action
                                    actions.push(action);
                                    
                                    // 构建前缀树
                                    let current = tree;
                                    let currentPath = '';
                                    
                                    parts.forEach((part, index) => {
                                        if (!current.children[part]) {
                                            current.children[part] = { children: {}, actions: [] };
                                        }
                                        current = current.children[part];
                                        currentPath = currentPath ? currentPath + '.' + part : part;
                                        
                                        // 将 action 添加到当前节点
                                        if (!current.actions.includes(actionName)) {
                                            current.actions.push(actionName);
                                        }
                                    });
                                });
                            });
                        });
                    });
                    
                    this.prefixTree = tree;
                    this.allActions = actions;
                    console.log('前缀树构建完成，共', actions.length, '个 action');
                },
                selectPrefix(prefix) {
                    if (this.selectedPrefix === prefix) {
                        // 如果点击已选中的前缀，取消选择
                        this.selectedPrefix = null;
                    } else {
                        this.selectedPrefix = prefix;
                    }
                },
                togglePrefix(prefix) {
                    this.expandedPrefixes[prefix] = !this.expandedPrefixes[prefix];
                },
                renderPrefixTree(node, prefix = '') {
                    // 递归渲染前缀树
                    const result = [];
                    const keys = Object.keys(node.children || {}).sort();
                    
                    keys.forEach(key => {
                        const fullPrefix = prefix ? prefix + '.' + key : key;
                        const childNode = node.children[key];
                        const hasChildren = Object.keys(childNode.children || {}).length > 0;
                        
                        result.push({
                            prefix: fullPrefix,
                            key: key,
                            actions: childNode.actions || [],
                            hasChildren: hasChildren,
                            children: hasChildren ? this.renderPrefixTree(childNode, fullPrefix) : []
                        });
                    });
                    
                    return result;
                },
                saveToHistory(action, params, serverUrl) {
                    if (!action) return;
                    
                    // 序列化参数用于比较
                    const paramsStr = JSON.stringify(params || {});
                    
                    // 检查历史记录中是否已存在相同的 action 和参数
                    const existingIndex = this.requestHistory.findIndex(h => {
                        return h.action === action && JSON.stringify(h.params || {}) === paramsStr;
                    });
                    
                    const historyItem = {
                        id: Date.now().toString(),
                        action: action,
                        params: params || {},
                        serverUrl: serverUrl || this.serverUrl,
                        timestamp: Date.now(),
                        pinned: false
                    };
                    
                    if (existingIndex !== -1) {
                        // 如果已存在，更新该记录的时间戳
                        this.requestHistory[existingIndex] = historyItem;
                    } else {
                        // 如果不存在，插入新记录
                        this.requestHistory.unshift(historyItem);
                        
                        // 最多保存30组数据
                        if (this.requestHistory.length > 30) {
                            this.requestHistory = this.requestHistory.slice(0, 30);
                        }
                    }
                    
                    // 保存到 localStorage
                    this.saveHistoryToStorage();
                },
                loadFromHistory() {
                    try {
                        const key = `requestHistory_${this.currentDocName}`;
                        const saved = localStorage.getItem(key);
                        if (saved) {
                            this.requestHistory = JSON.parse(saved);
                            // 确保每个历史记录项都有pinned字段（向后兼容）
                            this.requestHistory.forEach(item => {
                                if (item.pinned === undefined) {
                                    item.pinned = false;
                                }
                            });
                            // 确保不超过30条
                            if (this.requestHistory.length > 30) {
                                this.requestHistory = this.requestHistory.slice(0, 30);
                                this.saveHistoryToStorage();
                            }
                        } else {
                            this.requestHistory = [];
                        }
                    } catch (e) {
                        console.error('加载历史记录失败:', e);
                        this.requestHistory = [];
                    }
                },
                saveHistoryToStorage() {
                    try {
                        const key = `requestHistory_${this.currentDocName}`;
                        localStorage.setItem(key, JSON.stringify(this.requestHistory));
                    } catch (e) {
                        console.error('保存历史记录失败:', e);
                    }
                },
                applyHistory(historyItem) {
                    // 应用历史记录到表单
                    if (historyItem.serverUrl) {
                        this.serverUrl = historyItem.serverUrl;
                    }
                    
                    // 查找对应的 action
                    if (this.docData && this.docData.files) {
                        let foundAction = null;
                        for (const file of this.docData.files) {
                            for (const group of file.middlewareGroups) {
                                for (const category of group.categories) {
                                    foundAction = category.actions.find(a => a.name === historyItem.action);
                                    if (foundAction) break;
                                }
                                if (foundAction) break;
                            }
                            if (foundAction) break;
                        }
                        
                        if (foundAction) {
                            // 先选择 action（会重置表单）
                            this.selectAction(foundAction);
                            
                            // 填充参数到 formData（处理嵌套对象）
                            if (historyItem.params && Object.keys(historyItem.params).length > 0) {
                                // 将历史记录的 params 填充到 formData
                                if (this.selectedAction && this.selectedAction.params) {
                                    for (const param of this.selectedAction.params) {
                                        if (param.Name.includes('.')) {
                                            // 处理嵌套参数（如 page.current）
                                            const parts = param.Name.split('.');
                                            const parentKey = parts[0];
                                            const childKey = parts.slice(1).join('.');
                                            
                                            if (historyItem.params[parentKey] && typeof historyItem.params[parentKey] === 'object') {
                                                const value = this.getNestedValue(historyItem.params[parentKey], childKey);
                                                if (value !== undefined) {
                                                    this.formData[param.Name] = value;
                                                }
                                            }
                                        } else {
                                            // 普通参数
                                            if (historyItem.params[param.Name] !== undefined) {
                                                this.formData[param.Name] = historyItem.params[param.Name];
                                            }
                                        }
                                    }
                                }
                                
                                // 填充参数到 jsonParamsText（格式化 JSON）
                                this.jsonParamsText = JSON.stringify(historyItem.params, null, 2);
                                
                                // 如果当前是表单模式，同步数据
                                if (this.paramsEditMode === 'form') {
                                    this.parseJsonParams();
                                }
                            }
                        } else {
                            console.warn('找不到对应的 action: ' + historyItem.action);
                        }
                    }
                },
                deleteHistory(id) {
                    this.requestHistory = this.requestHistory.filter(h => h.id !== id);
                    this.saveHistoryToStorage();
                },
                pinHistory(id) {
                    const item = this.requestHistory.find(h => h.id === id);
                    if (item) {
                        item.pinned = !item.pinned;
                        this.saveHistoryToStorage();
                    }
                },
                clearHistory() {
                    const pinnedCount = this.requestHistory.filter(h => h.pinned).length;
                    let message = '确定要清空所有历史记录吗？';
                    if (pinnedCount > 0) {
                        message = `确定要清空所有历史记录吗？\n（将保留 ${pinnedCount} 条置顶记录）`;
                    }
                    if (confirm(message)) {
                        // 只删除未置顶的记录，保留置顶的记录
                        this.requestHistory = this.requestHistory.filter(h => h.pinned);
                        this.saveHistoryToStorage();
                    }
                },
                getFilteredHistory() {
                    let filtered = this.requestHistory;
                    
                    // 如果有搜索过滤，先过滤
                    if (this.historyFilter) {
                        const filter = this.historyFilter.toLowerCase();
                        filtered = this.requestHistory.filter(h => {
                            return h.action.toLowerCase().includes(filter) ||
                                   JSON.stringify(h.params).toLowerCase().includes(filter);
                        });
                    }
                    
                    // 排序：置顶的排在前面，然后按时间戳降序
                    return filtered.sort((a, b) => {
                        // 如果置顶状态不同，置顶的排在前面
                        if (a.pinned !== b.pinned) {
                            return a.pinned ? -1 : 1;
                        }
                        // 如果置顶状态相同，按时间戳降序（最新的在前）
                        return new Date(b.timestamp) - new Date(a.timestamp);
                    });
                },
                getRecentHistoryActions() {
                    // 获取最新10条，去重（相同action只保留最新一条或置顶的那条）
                    const seen = new Map();
                    for (const item of this.requestHistory) {
                        if (!seen.has(item.action)) {
                            seen.set(item.action, item);
                        } else {
                            const existing = seen.get(item.action);
                            // 优先保留置顶的，如果都不置顶或都置顶，则保留最新的
                            if (item.pinned && !existing.pinned) {
                                seen.set(item.action, item);
                            } else if (item.pinned === existing.pinned && item.timestamp > existing.timestamp) {
                                seen.set(item.action, item);
                            }
                        }
                    }
                    // 转换为数组，排序：置顶的排在前面，然后按时间戳降序，取前10条
                    return Array.from(seen.values())
                        .sort((a, b) => {
                            // 如果置顶状态不同，置顶的排在前面
                            if (a.pinned !== b.pinned) {
                                return a.pinned ? -1 : 1;
                            }
                            // 如果置顶状态相同，按时间戳降序（最新的在前）
                            return new Date(b.timestamp) - new Date(a.timestamp);
                        })
                        .slice(0, 10);
                },
                formatParamsForDisplay(params) {
                    if (!params || Object.keys(params).length === 0) {
                        return '';
                    }
                    try {
                        const jsonStr = JSON.stringify(params, null, 0);
                        // 如果超过100字符，截断并添加省略号
                        if (jsonStr.length > 100) {
                            return jsonStr.substring(0, 100) + '...';
                        }
                        return jsonStr;
                    } catch (e) {
                        return String(params);
                    }
                },
                onSearchInput() {
                    if (!this.searchQuery || !this.searchQuery.trim()) {
                        this.searchMatchedActions = null;
                        // 清空搜索时，折叠所有分组
                        this.collapseAll();
                        return;
                    }
                    
                    const query = this.searchQuery.trim().toLowerCase();
                    const matchedSet = new Set();
                    
                    // 优化搜索：支持从任意位置匹配（包含匹配）
                    // 例如：cha.check, check, ptcha 都能匹配 captcha.check
                    // 直接在所有 action 名称中进行包含匹配
                    this.allActions.forEach(action => {
                        const actionNameLower = action.name.toLowerCase();
                        // 匹配包含查询的 action 名称（任意位置）
                        if (actionNameLower.includes(query)) {
                            matchedSet.add(action.name);
                        }
                    });
                    
                    this.searchMatchedActions = matchedSet.size > 0 ? matchedSet : null;
                    
                    // 如果搜索结果为空，折叠所有分组
                    if (!this.searchMatchedActions || this.searchMatchedActions.size === 0) {
                        this.collapseAll();
                    } else {
                        // 自动展开左侧树，显示匹配项
                        this.expandForMatches(this.searchMatchedActions);
                    }
                },
                collapseAll() {
                    // 折叠所有分组和分类
                    if (this.docData && this.docData.files) {
                        this.docData.files.forEach(file => {
                            file.middlewareGroups.forEach(group => {
                                this.expandedGroups[group.name] = false;
                                group.categories.forEach(category => {
                                    this.expandedCategories[`${group.name}-${category.name}`] = false;
                                });
                            });
                        });
                    }
                },
                expandForMatches(matchedSet) {
                    if (!matchedSet || !this.docData || !this.docData.files) return;
                    
                    this.docData.files.forEach(file => {
                        file.middlewareGroups.forEach(group => {
                            let groupHasMatch = false;
                            group.categories.forEach(category => {
                                const categoryHasMatch = category.actions.some(a => matchedSet.has(a.name));
                                if (categoryHasMatch) {
                                    this.expandedCategories[`${group.name}-${category.name}`] = true;
                                    groupHasMatch = true;
                                }
                            });
                            if (groupHasMatch) {
                                this.expandedGroups[group.name] = true;
                            }
                        });
                    });
                },
                clearSearch() {
                    this.searchQuery = '';
                    this.searchMatchedActions = null;
                },
                hasMatchingActionsInGroup(group) {
                    // 如果没有过滤，显示所有分组
                    if (!this.filteredActions) {
                        return true;
                    }
                    // 检查分组下是否有任何匹配的 action，并且该 action 所在的分类也有匹配
                    if (!group.categories || group.categories.length === 0) {
                        return false;
                    }
                    // 必须至少有一个分类有匹配的 action，分组才显示
                    for (const category of group.categories) {
                        if (this.hasMatchingActionsInCategory(category)) {
                            return true;
                        }
                    }
                    return false;
                },
                hasMatchingActionsInCategory(category) {
                    // 如果没有过滤，显示所有分类
                    if (!this.filteredActions) {
                        return true;
                    }
                    // 检查分类下是否有任何匹配的 action
                    if (!category.actions || category.actions.length === 0) {
                        return false;
                    }
                    return category.actions.some(action => this.filteredActions.has(action.name));
                }
            }
                    }).mount('#app');
                    
                    console.log('Vue 应用初始化成功');
                } catch (error) {
                    console.error('Vue 应用初始化失败:', error);
                    const app = document.getElementById('app');
                    if (app) {
                        app.innerHTML = '<div class="p-8 text-center text-red-600"><p>错误：Vue 应用初始化失败</p><p class="text-sm mt-2">' + error.message + '</p></div>';
                    }
                }
            }

            // 如果 Vue 已经加载，直接初始化
            if (typeof Vue !== 'undefined') {
                initVue();
            } else {
                // 等待 Vue 库加载，最多等待 5 秒
                let attempts = 0;
                const maxAttempts = 50; // 5秒 = 50 * 100ms
                const checkVue = setInterval(function() {
                    attempts++;
                    if (typeof Vue !== 'undefined') {
                        clearInterval(checkVue);
                        initVue();
                    } else if (attempts >= maxAttempts) {
                        clearInterval(checkVue);
                        console.error('Vue 库加载超时');
                        const app = document.getElementById('app');
                        if (app) {
                            app.innerHTML = '<div class="p-8 text-center text-red-600"><p>错误：Vue 库加载超时，请检查网络连接</p></div>';
                        }
                    }
                }, 100);
            }
        });
    </script>
</body>
</html>
